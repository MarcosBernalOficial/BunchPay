<div class="min-h-screen flex bg-black text-white">
  <div class="w-1/4 border-r border-white/20 p-4 space-y-4">
    <div class="flex items-center gap-2">
      <h2 class="font-semibold text-xl border-l border-white px-2">Chats</h2>
      <button (click)="logout()" class="ml-auto px-3 py-1 rounded border text-red-500 border-red-500/40 hover:border-red-500/40 hover:bg-red-500 hover:text-white transition duration-300">Cerrar sesión</button>
    </div>
    <div class="flex gap-2 border-b border-white/20 pb-4">
      <button (click)="tab='unassigned'" [class.bg-white]="tab==='unassigned'" [class.text-black]="tab==='unassigned'" class="px-3 py-1 rounded border border-white/40 hover:scale-105 transition-transform duration-200">Sin asignar</button>
      <button (click)="tab='my'" [class.bg-white]="tab==='my'" [class.text-black]="tab==='my'" class="px-3 py-1 rounded border border-white/40 hover:scale-105 transition-transform duration-200">Mis chats</button>
  <!-- Botón de refrescar eliminado: ahora se actualiza automáticamente vía WS y fallback por intervalo -->
    </div>

    <!-- Listas -->
    @if (tab==='unassigned') {
      <div class="space-y-2">
        @if (loadingLists) {
          <div class="p-3 rounded border border-white/20 animate-pulse">
            <div class="h-3 w-2/3 bg-white/20 rounded mb-2"></div>
            <div class="h-4 w-1/2 bg-white/30 rounded"></div>
          </div>
          <div class="p-3 rounded border border-white/20 animate-pulse">
            <div class="h-3 w-2/3 bg-white/20 rounded mb-2"></div>
            <div class="h-4 w-1/2 bg-white/30 rounded"></div>
          </div>
          <div class="p-3 rounded border border-white/20 animate-pulse">
            <div class="h-3 w-2/3 bg-white/20 rounded mb-2"></div>
            <div class="h-4 w-1/2 bg-white/30 rounded"></div>
          </div>
        } @else {
          @for (c of unassigned; track c.id) {
            <div (click)="pick(c)" class="p-3 rounded border border-white/20 hover:border-white/60 cursor-pointer">
              <div class="text-sm opacity-80">{{ c.clientEmail }}</div>
              <div class="font-medium">{{ c.clientName || 'Cliente' }}</div>
            </div>
          }
          @if (!unassigned.length) {
            <div class="text-sm opacity-60">No hay chats sin asignar</div>
          }
        }
      </div>
    }

    @if (tab==='my') {
      <div class="space-y-2">
        @if (loadingLists) {
          <div class="p-3 rounded border border-white/20 animate-pulse">
            <div class="h-3 w-2/3 bg-white/20 rounded mb-2"></div>
            <div class="h-4 w-1/2 bg-white/30 rounded"></div>
          </div>
          <div class="p-3 rounded border border-white/20 animate-pulse">
            <div class="h-3 w-2/3 bg-white/20 rounded mb-2"></div>
            <div class="h-4 w-1/2 bg-white/30 rounded"></div>
          </div>
        } @else {
          @for (c of myChats; track c.id) {
            <div (click)="pick(c)" class="p-3 rounded border border-white/20 hover:border-white/60 cursor-pointer">
              <div class="text-sm opacity-80">{{ c.clientEmail }}</div>
              <div class="font-medium">{{ c.clientName || 'Cliente' }}</div>
              <div class="text-xs" [class.text-green-400]="!c.closed" [class.text-red-400]="c.closed">{{ c.closed ? 'Cerrado' : 'Abierto' }}</div>
            </div>
          }
          @if (!myChats.length) {
            <div class="text-sm opacity-60">No tenés chats asignados</div>
          }
        }
      </div>
    }
  </div>

  <div class="flex-1 p-4 flex flex-col">
    @if (!selected) {
      <div class="m-auto opacity-60">Seleccioná un chat</div>
    }

    @if (selected) {
      <div class="flex flex-col h-full">
      <!-- Mensajes de feedback -->
      @if (assignSuccess) {
        <div class="mb-3 p-3 bg-green-900/50 border border-green-700 rounded-md text-green-300 flex items-center gap-2">
          <span class="text-green-400">✔</span>
          <span>{{ assignSuccess }}</span>
        </div>
      }
      @if (assignError) {
        <div class="mb-3 p-3 bg-red-900/50 border border-red-700 rounded-md text-red-300 flex items-center gap-2">
          <span class="text-red-400">⚠</span>
          <span>{{ assignError }}</span>
        </div>
      }
      @if (closeSuccess) {
        <div class="mb-3 p-3 bg-green-900/50 border border-green-700 rounded-md text-green-300 flex items-center gap-2">
          <span class="text-green-400">✔</span>
          <span>{{ closeSuccess }}</span>
        </div>
      }
      @if (closeError) {
        <div class="mb-3 p-3 bg-red-900/50 border border-red-700 rounded-md text-red-300 flex items-center gap-2">
          <span class="text-red-400">⚠</span>
          <span>{{ closeError }}</span>
        </div>
      }
      
      <div class="flex items-center gap-2 border-b border-white/20 pb-2">
        <div class="font-semibold">{{ selected.clientName || selected.clientEmail }}</div>
        <span class="text-xs px-2 py-0.5 rounded border border-white/30" [class.text-green-400]="!selected.closed" [class.text-red-400]="selected.closed">{{ selected.closed ? 'Cerrado' : 'Abierto' }}</span>
        <div class="ml-auto flex gap-2">
          @if (selected.supportName === 'No asignado') {
            <button 
              (click)="assignSelected()" 
              [disabled]="assigning"
              class="px-3 py-1 rounded border border-white/40 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
              @if (assigning) {
                <span class="inline-block animate-spin rounded-full h-3 w-3 border-b-2 border-white"></span>
                <span>Asignando...</span>
              } @else {
                <span>Asignarme</span>
              }
            </button>
          }
          @if (selected.supportName !== 'No asignado' && !selected.closed) {
            <button 
              (click)="closeSelected()" 
              [disabled]="closing"
              class="px-3 py-1 rounded border border-white/40 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
              @if (closing) {
                <span class="inline-block animate-spin rounded-full h-3 w-3 border-b-2 border-white"></span>
                <span>Cerrando...</span>
              } @else {
                <span>Cerrar</span>
              }
            </button>
          }
        </div>
      </div>

      @if (loadingMessages) {
        <div class="flex-1 flex items-center justify-center opacity-60">Cargando mensajes...</div>
      } @else {
        <div class="flex-1 overflow-y-auto space-y-2 py-3">
          @for (m of messages; track m.id) {
            <div class="flex" [class.justify-end]="isMine(m)" [class.justify-start]="!isMine(m)">
              <div class="max-w-[75%] p-2 rounded border"
                    [class.border-white/10]="!isMine(m)" [class.bg-white/10]="!isMine(m)"
                    [class.border-white/80]="isMine(m)" [class.bg-white]="isMine(m)" [class.text-black]="isMine(m)">
                <div class="text-[11px] opacity-60" [class.text-right]="isMine(m)">
                  {{ m.senderEmail || m.senderName || m.sender?.email }}
                </div>
                <div class="whitespace-pre-wrap">{{ m.content }}</div>
                <div class="text-[10px] opacity-50" [class.text-right]="isMine(m)">{{ m.date | date:'short' }}</div>
              </div>
            </div>
          }
        </div>
      }

      <div class="pt-2 border-t border-white/20 flex gap-2">
        <input [(ngModel)]="newMessage" (keyup.enter)="send()" class="flex-1 px-3 py-2 bg-black border border-white/30 rounded" placeholder="Escribe un mensaje..." [disabled]="loadingMessages || selected.supportName === 'No asignado'" />
        <button (click)="send()" class="px-4 py-2 border border-white/40 rounded disabled:opacity-50 disabled:cursor-not-allowed" [disabled]="loadingMessages || selected.supportName === 'No asignado'">Enviar</button>
      </div>
      @if (selected.supportName === 'No asignado') {
        <div class="text-xs text-white/50 text-center mt-2">
          Asignate este chat para poder responder
        </div>
      }
    </div>
    }
  </div>
</div>
